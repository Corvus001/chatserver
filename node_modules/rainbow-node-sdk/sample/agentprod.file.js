// agent.js
// =============================================================================
// init

"use strict";

var RainbowSDK = require("../index.js");
const path = require("path");
const fs = require("fs");
const Conversation = require("../lib/common/models/Conversation");

// LOGGER
var winston = require("winston");
var logger = new winston.Logger({
  transports: [new (winston.transports.Console)()]
});

let options = {
  "rainbow": {
    "host": "sandbox", // Can be "sandbox" (developer platform), "official" or any other hostname when using dedicated AIO
  },
  "credentials": {
    // "login": "zucher@free.fr", // The Rainbow email account to use
    // "password": "Alcatel1!*" // The Rainbow associated password to use
    "login": "zucher@free.fr", // The Rainbow email account to use
    "password": "Alcatel1!*" // The Rainbow associated password to use
  },
  // Application identifier
  application:    { appID: '67e138206efb11e89919570eb30635e8',
  appSecret: 'MkbQ00H9QH8cgsZBrIPdUaU4eQ9My0GMlGQpGoBor63BsSmNBEm6K5gzuFCbZI0b' },
  // Logs options
  "logs": {
    "enableConsoleLogs": true, // Default: true
    "enableFileLogs": false, // Default: false
    "file": {
      "path": "/var/tmp/rainbowsdk/", // Default path used
      "level": "debug" // Default log level used
    }
  },
  // Proxy configuration
  /*   "proxy": {
        "host": "192.168.254.49",
        "port": 8080,
        "http": "http"
    },*/
  // IM options
  "im": {
    "sendReadReceipt": true // True to send the 'read' receipt automatically
  }
};

// instantiate the SDK
var rainbowSDK = new RainbowSDK(options);

// start the SDK
rainbowSDK.start();

// =============================================================================
// =============================================================================
// =============================================================================
// SEND PART

var sendResponse = function(message, idUser, lang, content, subject) {
  var messageSent = rainbowSDK
    .im
    .sendMessageToJid(message.response, idUser, lang, content, subject);
};

// =============================================================================
// =============================================================================
// =============================================================================
// RECEIVE PART

rainbowSDK
  .events
  .on("rainbow_onmessagereceived", function(message) {
    try {
    logger.log(message);
    if (message.event && ["leave", "close"].indexOf(message.event) >= 0) {
      return;
    }

    let contact = null;

      return rainbowSDK.contacts.getContactByJid(message.fromJid).then( (_contact) => {
        contact = _contact;

      let stat =   fs.statSync(path.resolve(__dirname, "../nodeSheet.pdf"));

      return rainbowSDK.fileStorage.createFileDescriptor( "nodeSheet", "pdf", stat.size, [] /* [{ viewerId: contact.id , type:"user"}] */);
    }).then( (fileDescriptor) => {
      return rainbowSDK.fileServer.uploadAFileByChunk( fileDescriptor, path.resolve(__dirname, "../nodeSheet.pdf"), (size) => console.log(size) );
    });

    /* 

    let conversationbubble = rainbowSDK
      .conversations
      .getConversations().find( (conv)=> {
        return conv && conv.bubble;
      });

      rainbowSDK.bubbles.closeBubble(conversationbubble.bubble).then(bubbleClosed => {
          let conversation = rainbowSDK.conversations.getConversationByBubbleId(conversationbubble.bubble.id);
          rainbowSDK.conversations.getHistoryPage(conversation,100).then( (conversationUpdated)  => {
        });
      });
      */
/*
    let conversations = rainbowSDK
      .conversations
      .getConversations();
    let conversation = null;
    rainbowSDK
      .conversations
      .getHistoryPage(conversations[0], 20)
      .then((conv) => {
        conversation = conv;

        rainbowSDK
      .conversations.getConversationByBubbleId(conv.bubble.id);
        // return rainbowSDK
        //   .im
        //   .getMessagesFromConversation(conversations[0], 30);
        return Promise.resolve( conv);
      })
      .then(() => {
        return rainbowSDK
          .conversations
          .updateServerConversation(conversation.dbId, true);
      })
      .then(() => {
        return rainbowSDK
          .conversations
          .updateServerConversation(conversation.dbId, false);
      })
      .then(() => {
        return rainbowSDK
          .im
          .sendMessageToConversation(conversation, "nothing", "en", {
            "message": "###\r\n" +
            "Test\r\n" +
            "| Titre 1 | Titre 2 | Titre 3 |\r\n" +
            "| -- | -- | -- | -- |\r\n" +
            "| Colonne | Colonne | Colonne |\r\n" +
            "| Alignée à | Alignée au | Alignée à |\r\n" +
            "| Gauche | Centre | Droite |"

          }, "My subject");
      })
      .then(() => {
        return rainbowSDK
          .conversations
          .sendConversationByEmail(conversation.dbId);
      })
      // .then(() => {
      //   return rainbowSDK
      //     .conversations
      //     .removeAllMessages(conversation);
      // })
      .then(() => {
        return rainbowSDK
          .conversations
          .ackAllMessages(conversation.dbId);
      })
      .then(() => {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve(rainbowSDK.conversations.closeConversation(conversation));
          }, 5000);
        });
      }).catch( (err) => {
        console.log(err);
      });
      */

    if (message.content === "md") {
      sendResponse({
        response: "nothing"
      }, message.fromJid, "en", {
        "message": "### Test\r\n| Titre 1       |     Titre 2     |   Titre 3      || ------------- " +
            "| -------------   | ---------      || Colonne       |     Colonne     |      Col" +
            "onne   || Alignée à     |      Alignée au |     Alignée à  || Gauche        |   " +
            "   Centre     |      Droite    |"

      }, "My subject");
    }

    if (["online", "away", "dnd", "invisible"].indexOf(message.content) > -1) {
      rainbowSDK
        .presence
        .setPresenceTo(message.content);
      console.log("Settings updated to : " + message.content);
    }
  

    rainbowSDK
      ._core
      ._xmpp
      .sendPing();
    /*
    let bubbleList = rainbowSDK
      .bubbles
      .createBubble(`My bubble ${Date.now().toString()}`, "desc", false)
      .then((bubble) => {

        sendResponse({
          response: `bubbles: ${bubble.name} => Created !`
        }, message.fromJid, message.lang);
      });
      */
    } catch( err ) {
      console.log(err);
    } 

  });
